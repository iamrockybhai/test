<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Speedometer Progress</title>
  <style>
    /* Popup Styles */
    #error-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 20px;
      border-radius: 5px;
      z-index: 1000;
      text-align: center;
    }
    #error-popup button {
      margin-top: 10px;
      background: white;
      color: red;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      font-weight: bold;
    }
    /* List (Progress) Styles */
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      margin: 10px 0;
      font-size: 18px;
      display: flex;
      align-items: center;
    }
    li span.icon {
      margin-right: 10px;
      font-size: 20px;
    }
    .tick {
      color: green;
    }
    .cross {
      color: red;
    }
    .loading {
      color: orange;
    }
    /* Button Style */
    #start-button {
      display: block;
      margin: 50px auto;
      padding: 15px 30px;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="start-button">Start Speedometer</button>

  <ul>
    <li id="location-status">
      <span id="location-icon" class="icon cross">❌</span>
      <span id="location-text">Step 1: Please allow location access in your browser</span>
    </li>
    <li id="gps-status">
      <span id="gps-icon" class="icon cross">❌</span>
      <span id="gps-text">Step 2: Please enable GPS on your device</span>
    </li>
  </ul>

  <div id="error-popup">
    <p id="error-message"></p>
    <button onclick="closePopup()">OK</button>
  </div>

  <script>
    // Global variable for our interval timer
    let progressInterval = null;

    // --- UI Update Functions ---

    // Updates the location access UI with a professional label.
    function updateLocationStatus(allowed) {
      const icon = document.getElementById("location-icon");
      const text = document.getElementById("location-text");
      if (allowed) {
        icon.className = "icon tick";
        icon.innerText = "✔️";
        text.innerText = "Step 1: Location Access Allowed.";
      } else {
        icon.className = "icon cross";
        icon.innerText = "❌";
        text.innerText = "Step 1: Please allow location access in your browser.";
      }
    }

    // Updates the GPS UI with a professional label.
    // status can be "loading", true (enabled), or false (not enabled)
    function updateGPSStatus(status) {
      const icon = document.getElementById("gps-icon");
      const text = document.getElementById("gps-text");
      if (status === "loading") {
        icon.className = "icon loading";
        icon.innerText = "⏳";
        text.innerText = "Step 2: Checking if GPS is enabled...";
      } else if (status === true) {
        icon.className = "icon tick";
        icon.innerText = "✔️";
        text.innerText = "Step 2: GPS Enabled.";
      } else {
        icon.className = "icon cross";
        icon.innerText = "❌";
        text.innerText = "Step 2: Please enable GPS on your device.";
      }
    }

    // --- Error Popup ---
    function showErrorPopup(message) {
      document.getElementById("error-message").innerText = message;
      document.getElementById("error-popup").style.display = "block";
    }
    function closePopup() {
      document.getElementById("error-popup").style.display = "none";
    }

    // --- Status Check Functions ---

    // Check the current location permission state (without prompting) and update UI.
    function checkLocationState() {
      if ("permissions" in navigator) {
        navigator.permissions.query({ name: "geolocation" }).then(function (ps) {
          updateLocationStatus(ps.state === "granted");
        });
      } else {
        // Fallback if Permissions API is not available
        updateLocationStatus(false);
      }
    }

    // Check GPS state by attempting to get the current position with a short timeout.
    function checkGPSState() {
      if ("permissions" in navigator) {
        navigator.permissions.query({ name: "geolocation" }).then(function (ps) {
          if (ps.state === "granted") {
            navigator.geolocation.getCurrentPosition(
              function (position) {
                updateGPSStatus(true);
              },
              function (error) {
                updateGPSStatus(false);
              },
              { enableHighAccuracy: true, maximumAge: 0, timeout: 3000 }
            );
          } else {
            updateGPSStatus(false);
          }
        });
      } else {
        updateGPSStatus(false);
      }
    }

    // --- Main Process Function ---

    // Called when the user clicks the button.
    // It forces a prompt for location access and then starts checking progress every 3 seconds.
    function startProgress() {
      // Force a prompt for location by calling getCurrentPosition.
      navigator.geolocation.getCurrentPosition(
        function (position) {
          updateLocationStatus(true);
          updateGPSStatus("loading");
        },
        function (error) {
          updateLocationStatus(false);
          updateGPSStatus(false);
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );

      // Clear any existing interval and start a new 3-second interval to update progress.
      if (progressInterval) clearInterval(progressInterval);
      progressInterval = setInterval(function () {
        checkLocationState();
        checkGPSState();
      }, 3000);
    }

    // Attach the process to the button click.
    document.getElementById("start-button").addEventListener("click", startProgress);
  </script>
</body>
</html>
